<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POSTURA</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #fce4ec);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .button-container {
      margin-bottom: 10px;
    }
    button {
      background-color: #00695c;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #004d40;
    }
    #imageCanvas {
      border: 2px dashed #ccc;
      border-radius: 10px;
      cursor: crosshair;
    }
    #highlightBox {
      position: absolute;
      border: 2px dashed rgba(0, 200, 0, 0.4);
      background-color: rgba(0, 255, 0, 0.1); /* faint highlight */
      display: none;
      pointer-events: none;
    }
    #processing {
      font-size: 16px;
      color: #333;
      font-weight: bold;
      margin-bottom: 10px;
      display: none;
    }
    #warning {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
    .canvas-container {
      position: relative;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="button-container">
    <button onclick="resetPoints()">Reset Points</button>
    <button onclick="uploadImage()">Capture / Upload Again</button>
    <button onclick="saveAttempt()">Save Attempt</button>
  </div>

  <div id="processing">Processing bounding box, please wait...</div>
  <div class="canvas-container">
    <canvas id="imageCanvas"></canvas>
    <div id="highlightBox"></div>
  </div>
  <div id="warning"></div>

  <script>
    const canvas = document.getElementById("imageCanvas");
    const ctx = canvas.getContext("2d");
    const highlightBox = document.getElementById("highlightBox");
    const processing = document.getElementById("processing");
    const warning = document.getElementById("warning");

    let points = [];
    let boundingBox = null;

    // Example image load
    const img = new Image();
    img.src = "man_side.png"; // Replace with uploaded/captured image
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Simulate bounding box detection
      showProcessing();
      setTimeout(() => {
        boundingBox = {
          x: 80,
          y: 40,
          width: img.width - 160,
          height: img.height - 80
        };
        drawHighlightBox(boundingBox);
        hideProcessing();
      }, 1500);
    };

    function drawHighlightBox(box) {
      highlightBox.style.display = "block";
      highlightBox.style.left = canvas.offsetLeft + box.x + "px";
      highlightBox.style.top = canvas.offsetTop + box.y + "px";
      highlightBox.style.width = box.width + "px";
      highlightBox.style.height = box.height + "px";
      highlightBox.style.position = "absolute";
    }

    function showProcessing() {
      processing.style.display = "block";
    }

    function hideProcessing() {
      processing.style.display = "none";
    }

    canvas.addEventListener("click", (event) => {
      if (!boundingBox) return;

      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // Check if inside bounding box
      if (x < boundingBox.x || x > boundingBox.x + boundingBox.width ||
          y < boundingBox.y || y > boundingBox.y + boundingBox.height) {
        warning.textContent = "⚠️ Please click only inside the highlighted area!";
        return;
      }

      points.push({x, y});
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // reset
      drawPointsAndLine();

      if (points.length === 2) validatePoints();
    });

    function drawPointsAndLine() {
      ctx.fillStyle = "red";
      points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
        ctx.fill();
      });
      if (points.length === 2) {
        ctx.strokeStyle = "blue";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[1].x, points[1].y);
        ctx.stroke();
      }
    }

    function validatePoints() {
      const dx = points[0].x - points[1].x;
      const dy = points[0].y - points[1].y;
      const distance = Math.sqrt(dx*dx + dy*dy);

      // Distance validation
      if (distance < 50) {
        warning.textContent = "⚠️ Points are too close! Please reselect.";
        return;
      } else if (distance > 400) {
        warning.textContent = "⚠️ Points are too far apart! Please reselect.";
        return;
      }

      // Angle validation
      const angle = Math.atan2(dy, dx) * (180 / Math.PI); // in degrees
      const normalizedAngle = Math.abs(angle);

      if (normalizedAngle < 30 || normalizedAngle > 75) {
        warning.textContent = `⚠️ Unusual angle detected (${normalizedAngle.toFixed(1)}°). Please check landmark placement.`;
      } else {
        warning.textContent = "";
      }
    }

    function resetPoints() {
      points = [];
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      warning.textContent = "";
    }

    function uploadImage() {
      alert("Upload feature not implemented in this demo.");
    }

    function saveAttempt() {
      if (points.length < 2) {
        alert("Please select both tragus and C7 before saving.");
        return;
      }
      if (warning.textContent !== "") {
        alert("Please fix the warnings before saving.");
        return;
      }
      alert("Attempt saved!");
    }
  </script>
</body>
</html>

