<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POSTURA</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #fce4ec);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      text-align: center;
      width: 90%;
      max-width: 600px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    canvas {
      border: 2px solid #ccc;
      border-radius: 10px;
      margin-top: 15px;
      max-width: 100%;
    }
    input, button {
      margin: 10px 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    input[type="file"] {
      background: #f1f1f1;
    }
    button {
      background: #00796b;
      color: white;
      transition: background 0.3s;
    }
    button:hover {
      background: #004d40;
    }
    #result, #finalResult {
      margin-top: 20px;
      font-weight: bold;
      color: #333;
    }
    #warning {
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }
    #processing {
      margin-top: 10px;
      color: #ff9800;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>POSTURA</h1>
    <input type="file" id="upload" accept="image/*">
    <button id="reset">Reset</button>
    <canvas id="canvas"></canvas>
    <div id="processing">Processing… Please wait</div>
    <div id="result"></div>
    <div id="warning"></div>
    <button id="saveAttempt" disabled>Save Attempt</button>
    <div id="attempts"></div>
    <div id="finalResult"></div>
  </div>

  <script>
    const upload = document.getElementById('upload');
    const reset = document.getElementById('reset');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const warning = document.getElementById('warning');
    const processing = document.getElementById('processing');
    const saveAttempt = document.getElementById('saveAttempt');
    const attemptsDiv = document.getElementById('attempts');
    const finalResult = document.getElementById('finalResult');

    let img = new Image();
    let points = [];
    let personBox = null;
    let currentCVA = null;
    let attempts = [];

    // Reset
    reset.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      points = [];
      result.textContent = '';
      warning.textContent = '';
      personBox = null;
      currentCVA = null;
      saveAttempt.disabled = true;
    });

    // Upload
    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          // Simulate detection (placeholder box)
          processing.style.display = "block";
          setTimeout(() => {
            processing.style.display = "none";
            personBox = {x: img.width*0.2, y: img.height*0.1, w: img.width*0.6, h: img.height*0.8};
            ctx.fillStyle = "rgba(0, 150, 255, 0.1)";
            ctx.fillRect(personBox.x, personBox.y, personBox.w, personBox.h);
            ctx.strokeStyle = "rgba(0, 150, 255, 0.5)";
            ctx.strokeRect(personBox.x, personBox.y, personBox.w, personBox.h);
          }, 1200);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Landmark clicks
    canvas.addEventListener('click', (e) => {
      if (!personBox) return alert("Please wait until processing is done.");
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Ensure clicks inside person box
      if (x < personBox.x || x > personBox.x+personBox.w || y < personBox.y || y > personBox.y+personBox.h) {
        warning.textContent = "⚠️ Please click only on the person!";
        return;
      }

      points.push({x, y});
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI*2);
      ctx.fill();

      if (points.length === 2) {
        calculateCVA();
      }
    });

    function calculateCVA() {
      warning.textContent = "";
      const [tragus, c7] = points;

      const dx = tragus.x - c7.x;
      const dy = tragus.y - c7.y;
      const dist = Math.sqrt(dx*dx + dy*dy);

      if (dist < 30) {
        warning.textContent = "⚠️ Landmarks too close!";
        points = [];
        return;
      }
      if (dist > canvas.width/1.2) {
        warning.textContent = "⚠️ Landmarks too far apart!";
        points = [];
        return;
      }

      let angle = Math.atan2(dy, dx) * (180/Math.PI);
      let cva = 90 - angle;

      if (cva < 0 || cva > 90) {
        warning.textContent = "⚠️ Implausible CVA angle detected!";
        result.textContent = "";
        points = [];
        return;
      }

      currentCVA = cva;
      saveAttempt.disabled = false;

      // Classification
      let classification = "";
      let recommendation = "";
      if (cva >= 55) {
        classification = "Good";
        recommendation = "Maintain your posture with regular breaks.";
      } else if (cva >= 50) {
        classification = "At Risk";
        recommendation = "Do stretching exercises and check your ergonomics.";
      } else {
        classification = "Poor";
        recommendation = "Consider posture correction exercises and workstation adjustments.";
      }

      result.textContent = `CVA: ${cva.toFixed(2)}° → ${classification} Posture\nRecommendation: ${recommendation}`;
    }

    // Save attempt
    saveAttempt.addEventListener('click', () => {
      if (currentCVA !== null && attempts.length < 3) {
        attempts.push(currentCVA);
        attemptsDiv.textContent = `Attempts: ${attempts.map(a => a.toFixed(2)+"°").join(", ")}`;
        points = [];
        saveAttempt.disabled = true;
        if (attempts.length === 3) {
          calculateFinalAverage();
        }
      }
    });

    function calculateFinalAverage() {
      const avg = attempts.reduce((a,b)=>a+b,0) / attempts.length;
      let classification = "";
      let recommendation = "";
      if (avg >= 55) {
        classification = "Good";
        recommendation = "Maintain your posture with regular breaks.";
      } else if (avg >= 50) {
        classification = "At Risk";
        recommendation = "Do stretching exercises and check your ergonomics.";
      } else {
        classification = "Poor";
        recommendation = "Consider posture correction exercises and workstation adjustments.";
      }
      finalResult.textContent = `Final Average CVA: ${avg.toFixed(2)}° → ${classification} Posture\nFinal Recommendation: ${recommendation}`;
    }
  </script>
</body>
</html>
